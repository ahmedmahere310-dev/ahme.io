<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>رَفوف | تواصل وتبادل</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root { --primary: #38bdf8; }
        body { 
            font-family: 'Cairo', sans-serif; 
            height: 100vh; 
            overflow: hidden; 
            background: #020617; 
            color: white; 
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        .bg-fixed { position: fixed; inset: 0; background: url('https://images.unsplash.com/photo-1507842217343-583bb7270b66?auto=format&fit=crop&q=80') center/cover; z-index: -2; }
        .overlay { position: fixed; inset: 0; background: radial-gradient(circle at top right, rgba(15, 23, 42, 0.8), rgba(2, 6, 23, 0.99)); z-index: -1; }
        
        .glass { 
            background: rgba(255, 255, 255, 0.03); 
            backdrop-filter: blur(25px) saturate(180%); 
            border: 1px solid rgba(255, 255, 255, 0.08); 
        }

        .screen { position: fixed; inset: 0; display: none; flex-direction: column; z-index: 10; padding-bottom: 90px; }
        .screen.active { display: flex; animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }

        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }

        .nav-bar { position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); width: 92%; max-width: 450px; height: 75px; z-index: 1000; border-radius: 2.2rem; display: none; justify-content: space-around; align-items: center; }
        
        .bubble { max-width: 85%; padding: 14px 18px; font-size: 14px; margin-bottom: 6px; position: relative; }
        .bubble.mine { background: linear-gradient(135deg, #0284c7, #0ea5e9); align-self: flex-end; border-radius: 22px 22px 4px 22px; }
        .bubble.theirs { background: rgba(255, 255, 255, 0.07); align-self: flex-start; border-radius: 22px 22px 22px 4px; }
        
        ::-webkit-scrollbar { width: 0px; }
        .book-card-img { aspect-ratio: 1 / 1; object-fit: cover; border-radius: 1.5rem; }
    </style>
</head>
<body>

    <div class="bg-fixed"></div>
    <div class="overlay"></div>

    <!-- شاشة الدخول -->
    <section id="scr-login" class="screen active items-center justify-center !pb-0 px-8">
        <div class="w-full max-w-sm text-center">
            <div class="mb-10 w-24 h-24 bg-sky-500 rounded-[2.5rem] flex items-center justify-center mx-auto shadow-2xl rotate-6 animate-pulse">
                <i data-lucide="book-marked" class="w-12 h-12 text-white -rotate-6"></i>
            </div>
            <h1 class="text-6xl font-black italic mb-2 tracking-tighter text-white">رَفوف</h1>
            <p class="text-sky-400 font-bold text-sm mb-12 uppercase tracking-widest">مبادلة الكتب بلمسة عصرية</p>
            <div class="space-y-4">
                <input id="login-phone" type="tel" placeholder="رقم الموبايل" class="w-full p-6 rounded-3xl bg-white/5 border border-white/10 text-center font-bold outline-none text-white focus:bg-white/10 transition-all">
                <div id="new-user-fields" class="hidden animate-fadeIn">
                    <input id="login-name" type="text" placeholder="اسمك بالكامل" class="w-full p-6 rounded-3xl bg-white/5 border border-white/10 text-center font-bold text-white outline-none mb-4">
                </div>
                <button onclick="checkUser()" class="w-full bg-sky-500 py-6 rounded-3xl font-black text-xl text-white shadow-2xl active:scale-95 transition-all">دخول</button>
            </div>
        </div>
    </section>

    <!-- الرئيسية -->
    <section id="scr-main" class="screen pt-6">
        <header class="p-6 flex justify-between items-center">
            <h2 class="text-4xl font-black italic tracking-tighter text-white">رَفوف</h2>
            <div class="flex gap-3">
                <button onclick="nav('scr-profile')" class="w-12 h-12 rounded-2xl glass p-1"><img id="header-pfp" src="" class="w-full h-full object-cover rounded-xl"></button>
                <button onclick="openAdd()" class="w-12 h-12 glass flex items-center justify-center text-white rounded-2xl"><i data-lucide="plus"></i></button>
            </div>
        </header>
        <div class="px-6 mb-6">
            <div class="relative glass rounded-2xl overflow-hidden flex items-center px-4">
                <i data-lucide="search" class="w-5 h-5 opacity-30 text-white"></i>
                <input id="book-search" oninput="searchBooks()" type="text" placeholder="ابحث عن كتاب..." class="w-full p-4 bg-transparent outline-none text-sm font-bold text-white">
            </div>
        </div>
        <div id="books-list" class="overflow-y-auto px-6 space-y-8 pb-28"></div>
    </section>

    <!-- شاشة بروفايل شخص آخر -->
    <section id="scr-user-view" class="screen pt-6 overflow-y-auto">
        <header class="p-6 flex items-center gap-4">
            <button onclick="nav('scr-main')" class="p-2 glass rounded-xl text-white"><i data-lucide="arrow-right"></i></button>
            <h3 class="font-black text-lg text-white">الملف الشخصي</h3>
        </header>
        <div class="flex flex-col items-center px-6 text-center">
            <div class="w-32 h-32 rounded-[3rem] glass p-1.5 shadow-2xl mb-4">
                <img id="view-pfp" src="" class="w-full h-full object-cover rounded-[2.8rem]">
            </div>
            <h3 id="view-name" class="text-3xl font-black mb-2 text-white">...</h3>
            
            <div class="flex gap-8 mb-6 bg-white/5 py-3 px-8 rounded-3xl border border-white/5">
                <div>
                    <p id="view-fers" class="text-xl font-black text-sky-400">0</p>
                    <p class="text-[9px] font-black opacity-40 uppercase text-white">متابع</p>
                </div>
                <div class="w-[1px] bg-white/10 h-8 self-center"></div>
                <div>
                    <p id="view-fing" class="text-xl font-black text-white">0</p>
                    <p class="text-[9px] font-black opacity-40 uppercase text-white">يتابع</p>
                </div>
            </div>

            <button id="view-follow-btn" onclick="toggleFollowView()" class="w-full max-w-xs py-4 rounded-2xl font-black text-sm mb-8 transition-all"></button>

            <div class="w-full text-right mb-4">
                <h4 class="text-xs font-black opacity-40 uppercase mr-2 text-white italic">كتب هذا المستخدم</h4>
            </div>
            <div id="view-user-books" class="w-full space-y-6 pb-20"></div>
        </div>
    </section>

    <!-- المحادثات -->
    <section id="scr-chats" class="screen pt-12 px-6">
        <h2 class="text-4xl font-black mb-8 italic text-white">المحادثات</h2>
        <div id="chats-list" class="space-y-3 overflow-y-auto"></div>
    </section>

    <!-- المحادثة النشطة -->
    <section id="scr-chat-window" class="screen bg-slate-950 !pb-0">
        <header class="p-4 glass rounded-none flex items-center gap-4 border-none border-b border-white/5 z-50">
            <button onclick="nav('scr-chats')" class="p-2 text-white"><i data-lucide="arrow-right"></i></button>
            <img id="chat-target-pfp" src="" class="w-11 h-11 rounded-full object-cover glass">
            <h4 id="chat-target-name" class="font-bold text-sm text-white flex-grow">...</h4>
        </header>
        <div id="chat-messages" class="flex-grow overflow-y-auto p-6 flex flex-col pt-8"></div>
        <div class="p-4 pb-10">
            <div class="glass flex gap-2 p-2 px-3 items-center rounded-3xl border-white/10">
                <input id="chat-input" type="text" placeholder="اكتب شيئاً..." class="flex-grow bg-transparent p-3 text-sm text-white outline-none">
                <button onclick="sendMessage()" class="w-12 h-12 bg-sky-500 rounded-full flex items-center justify-center text-white"><i data-lucide="send" class="w-5 h-5 mr-1"></i></button>
            </div>
        </div>
    </section>

    <!-- بروفايلي -->
    <section id="scr-profile" class="screen pt-12 px-6 overflow-y-auto items-center">
        <div class="w-full max-w-md flex flex-col items-center text-center">
            <div class="relative mb-6">
                <div class="w-32 h-32 rounded-[3rem] glass p-1.5 shadow-2xl">
                    <img id="profile-img" src="" class="w-full h-full object-cover rounded-[2.8rem]">
                </div>
                <button onclick="editPfpPrompt()" class="absolute bottom-0 right-0 bg-sky-500 w-10 h-10 rounded-2xl flex items-center justify-center border-4 border-slate-950 text-white"><i data-lucide="camera" class="w-5 h-5"></i></button>
            </div>
            <h3 id="profile-name" class="text-3xl font-black mb-2 text-white">...</h3>
            
            <div class="flex gap-8 mb-8 bg-white/5 py-4 px-8 rounded-3xl border border-white/5">
                <div><p id="count-followers" class="text-2xl font-black text-sky-400">0</p><p class="text-[10px] font-black opacity-40 uppercase text-white">متابع</p></div>
                <div class="w-[1px] bg-white/10 h-10 self-center"></div>
                <div><p id="count-following" class="text-2xl font-black text-white">0</p><p class="text-[10px] font-black opacity-40 uppercase text-white">يتابع</p></div>
            </div>

            <div class="glass p-8 w-full rounded-[2.5rem] mb-6 space-y-6">
                <input id="edit-name" type="text" class="w-full bg-white/5 p-4 rounded-2xl outline-none border border-white/5 text-white">
                <button onclick="saveProfile()" class="w-full bg-sky-500 py-5 rounded-2xl font-black text-white">تحديث البيانات</button>
            </div>
            <button onclick="logout()" class="w-full bg-red-500/10 text-red-500 py-5 rounded-2xl font-black text-xs uppercase mb-12 border border-red-500/10">تسجيل الخروج</button>
        </div>
    </section>

    <!-- الملاحة -->
    <nav id="nav-bar" class="nav-bar glass shadow-2xl border-white/10">
        <div onclick="nav('scr-main')" id="n-main" class="flex flex-col items-center gap-1 cursor-pointer transition-all text-white"><i data-lucide="layout-grid"></i><span class="text-[9px] font-black">الرئيسية</span></div>
        <div onclick="nav('scr-chats')" id="n-chats" class="flex flex-col items-center gap-1 opacity-30 cursor-pointer transition-all text-white"><i data-lucide="message-square"></i><span class="text-[9px] font-black">الدردشة</span></div>
        <div onclick="nav('scr-profile')" id="n-profile" class="flex flex-col items-center gap-1 opacity-30 cursor-pointer transition-all text-white"><i data-lucide="circle-user"></i><span class="text-[9px] font-black">حسابي</span></div>
    </nav>

    <!-- مودال إضافة كتاب -->
    <div id="mod-book" class="fixed inset-0 bg-black/80 hidden z-[2000] items-center justify-center p-6 backdrop-blur-2xl">
        <div class="glass p-8 w-full max-w-md rounded-[3rem]">
            <h3 class="text-3xl font-black mb-6 text-sky-400">نشر كتاب</h3>
            <div class="space-y-4">
                <input id="book-t" type="text" placeholder="عنوان الكتاب" class="w-full p-5 bg-white/5 rounded-2xl border border-white/10 outline-none text-white">
                <input id="book-c" type="text" placeholder="رابط صورة الغلاف" class="w-full p-5 bg-white/5 rounded-2xl border border-white/10 outline-none text-white">
                <textarea id="book-d" placeholder="نبذة عن الكتاب..." class="w-full p-5 bg-white/5 rounded-2xl border border-white/10 outline-none h-28 text-white"></textarea>
                <div class="flex gap-3 pt-4">
                    <button onclick="closeBookMod()" class="flex-1 bg-white/10 py-5 rounded-2xl font-black text-xs text-white">إلغاء</button>
                    <button onclick="saveBook()" class="flex-[2] bg-sky-500 py-5 rounded-2xl font-black text-sm text-white">نشر</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, remove, update, increment, get, serverTimestamp, off } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = { databaseURL: "https://coffee-spark-ai-barista-370d0-default-rtdb.firebaseio.com" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let user = JSON.parse(localStorage.getItem('rafouf_u'));
        let allBooks = [];
        let viewingUser = null;
        let chatTarget = null;
        let currentChatRef = null;

        window.nav = (id) => {
            const screens = document.querySelectorAll('.screen');
            screens.forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('nav div').forEach(d => d.classList.add('opacity-30'));
            const map = {'scr-main':'n-main','scr-chats':'n-chats','scr-profile':'n-profile'};
            if(map[id]) document.getElementById(map[id]).classList.remove('opacity-30');
            lucide.createIcons();
        };

        window.checkUser = async () => {
            const p = document.getElementById('login-phone').value.trim();
            if(!p) return;
            const snap = await get(ref(db, `users/${p}`));
            if(snap.exists()){
                user = snap.val();
            } else {
                const n = document.getElementById('login-name').value.trim();
                if(!n) { document.getElementById('new-user-fields').classList.remove('hidden'); return; }
                user = { name: n, phone: p, pfp: `https://api.dicebear.com/7.x/avataaars/svg?seed=${n}`, followers: 0, following: 0 };
                await set(ref(db, `users/${p}`), user);
            }
            localStorage.setItem('rafouf_u', JSON.stringify(user));
            loginSuccess();
        };

        function loginSuccess() {
            document.getElementById('nav-bar').style.display = 'flex';
            window.nav('scr-main');
            updateUI();
            syncData();
        }

        function updateUI() {
            if(!user) return;
            document.getElementById('header-pfp').src = user.pfp;
            document.getElementById('profile-img').src = user.pfp;
            document.getElementById('profile-name').innerText = user.name;
            document.getElementById('edit-name').value = user.name;
            document.getElementById('count-followers').innerText = user.followers || 0;
            document.getElementById('count-following').innerText = user.following || 0;
        }

        function syncData() {
            onValue(ref(db, `users/${user.phone}`), (snap) => {
                if(snap.exists()) {
                    user = snap.val();
                    localStorage.setItem('rafouf_u', JSON.stringify(user));
                    updateUI();
                }
            });
            onValue(ref(db, 'content'), (snap) => {
                allBooks = [];
                if(snap.exists()) {
                    Object.entries(snap.val()).forEach(([id, data]) => allBooks.push({id, ...data}));
                    renderBooks(allBooks.reverse());
                    if(viewingUser) renderUserView(viewingUser.phone);
                }
            });
        }

        function renderBooks(books) {
            const list = document.getElementById('books-list');
            list.innerHTML = '';
            books.forEach(b => {
                const liked = b.likedBy && b.likedBy[user.phone];
                list.innerHTML += `
                    <div class="glass p-5 rounded-[2.5rem] flex flex-col relative">
                        <div class="flex gap-5 mb-5 items-start">
                            <img src="${b.cover}" class="book-card-img w-28 h-28 shrink-0 shadow-2xl">
                            <div class="flex-grow text-right">
                                <h3 class="font-black text-lg mb-1 text-white">${b.title}</h3>
                                <div onclick="openUserView('${b.ownerId}')" class="flex items-center gap-2 mb-2 cursor-pointer">
                                    <p class="text-[10px] text-sky-400 font-black uppercase">@${b.ownerName}</p>
                                </div>
                                <p class="text-[10px] text-white opacity-40 line-clamp-2">${b.description || ''}</p>
                            </div>
                        </div>
                        <div class="flex justify-between items-center pt-4 border-t border-white/5">
                            <button onclick="toggleLike('${b.id}')" class="flex items-center gap-1.5 text-xs ${liked ? 'text-red-500' : 'text-white opacity-30'}">
                                <i data-lucide="heart" class="w-5 h-5 ${liked ? 'fill-red-500' : ''}"></i> <span>${b.likes || 0}</span>
                            </button>
                            <button onclick="requestSwap('${b.ownerId}','${b.ownerName}','${b.title}')" class="bg-sky-500/10 text-sky-400 px-5 py-2.5 rounded-xl text-[10px] font-black border border-sky-500/20">طلب تبادل</button>
                        </div>
                    </div>`;
            });
            lucide.createIcons();
        }

        // فتح بروفايل مستخدم آخر
        window.openUserView = async (targetId) => {
            if(targetId === user.phone) { window.nav('scr-profile'); return; }
            const snap = await get(ref(db, `users/${targetId}`));
            if(snap.exists()) {
                viewingUser = snap.val();
                renderUserView(targetId);
                window.nav('scr-user-view');
            }
        };

        function renderUserView(targetId) {
            const snapRef = ref(db, `users/${targetId}`);
            onValue(snapRef, (s) => {
                const u = s.val();
                if(!u) return;
                document.getElementById('view-pfp').src = u.pfp;
                document.getElementById('view-name').innerText = u.name;
                document.getElementById('view-fers').innerText = u.followers || 0;
                document.getElementById('view-fing').innerText = u.following || 0;
                
                const isFollowing = user.followingList && user.followingList[targetId];
                const btn = document.getElementById('view-follow-btn');
                btn.innerText = isFollowing ? "إلغاء المتابعة" : "متابعة +";
                btn.className = isFollowing ? 
                    "w-full max-w-xs py-4 rounded-2xl font-black text-sm mb-8 bg-white/5 border border-white/10 text-white opacity-50" : 
                    "w-full max-w-xs py-4 rounded-2xl font-black text-sm mb-8 bg-sky-500 text-white shadow-xl shadow-sky-900/40";

                const booksContainer = document.getElementById('view-user-books');
                const userBooks = allBooks.filter(b => b.ownerId === targetId);
                booksContainer.innerHTML = '';
                userBooks.forEach(b => {
                    booksContainer.innerHTML += `
                        <div class="glass p-4 rounded-[2rem] flex gap-4 items-center">
                            <img src="${b.cover}" class="w-16 h-16 rounded-xl object-cover shrink-0">
                            <div class="flex-grow text-right">
                                <h5 class="font-black text-sm text-white">${b.title}</h5>
                                <p class="text-[9px] opacity-40 text-white">${b.likes} إعجاب</p>
                            </div>
                        </div>`;
                });
            }, { onlyOnce: false });
        }

        window.toggleFollowView = async () => {
            if(!viewingUser) return;
            const tid = viewingUser.phone;
            const isFollowing = user.followingList && user.followingList[tid];
            await update(ref(db, `users/${user.phone}`), {
                following: increment(isFollowing ? -1 : 1),
                [`followingList/${tid}`]: isFollowing ? null : true
            });
            await update(ref(db, `users/${tid}`), {
                followers: increment(isFollowing ? -1 : 1),
                [`followersList/${user.phone}`]: isFollowing ? null : true
            });
        };

        window.toggleLike = async (bid) => {
            const b = allBooks.find(x => x.id === bid);
            const liked = b.likedBy && b.likedBy[user.phone];
            await update(ref(db, `content/${bid}`), {
                likes: increment(liked ? -1 : 1),
                [`likedBy/${user.phone}`]: liked ? null : true
            });
        };

        window.requestSwap = (oid, oname, title) => {
            const cid = [user.phone, oid].sort().join('_');
            const txt = `أرغب في مبادلة كتابك: ${title}`;
            push(ref(db, `chats/${cid}`), { sender: user.phone, text: txt });
            update(ref(db, `user_chats/${user.phone}/${oid}`), { lastMsg: txt, pfp: viewingUser?.pfp || '', name: oname });
            update(ref(db, `user_chats/${oid}/${user.phone}`), { lastMsg: txt, pfp: user.pfp, name: user.name });
            window.nav('scr-chats');
        };

        window.saveBook = async () => {
            const t = document.getElementById('book-t').value, c = document.getElementById('book-c').value, d = document.getElementById('book-d').value;
            if(!t || !c) return;
            await push(ref(db, 'content'), { title: t, cover: c, description: d, ownerId: user.phone, ownerName: user.name, likes: 0 });
            closeBookMod();
        };

        window.editPfpPrompt = () => {
            const p = prompt("رابط الصورة الجديد:");
            if(p) { update(ref(db, `users/${user.phone}`), { pfp: p }); user.pfp = p; localStorage.setItem('rafouf_u', JSON.stringify(user)); updateUI(); }
        };

        window.openAdd = () => document.getElementById('mod-book').classList.replace('hidden','flex');
        window.closeBookMod = () => document.getElementById('mod-book').classList.replace('flex','hidden');
        window.logout = () => { localStorage.clear(); location.reload(); };
        if(user) loginSuccess();
        lucide.createIcons();
    </script>
</body>
</html>