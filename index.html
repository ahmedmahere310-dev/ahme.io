<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>رَفوف | الإدارة والتبادل</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root { --primary: #0ea5e9; --lamp-color: rgba(253, 224, 71, 0.35); }
        body { font-family: 'Cairo', sans-serif; height: 100vh; overflow: hidden; transition: all 0.5s ease; }
        .bg-fixed-library { position: fixed; inset: 0; background: url('https://images.unsplash.com/photo-1507842217343-583bb7270b66?auto=format&fit=crop&q=80') center/cover no-repeat; z-index: -2; }
        .bg-overlay { position: fixed; inset: 0; z-index: -1; transition: all 0.5s ease; }
        body.light-mode .bg-overlay { background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(1px); }
        body.dark-mode .bg-overlay { background: rgba(2, 6, 23, 0.4); backdrop-filter: blur(2.5px); }
        .glass { background: rgba(255, 255, 255, 0.04); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 1.5rem; }
        body.light-mode .glass { background: rgba(255, 255, 255, 0.8); border: 1px solid rgba(255, 255, 255, 0.9); box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .screen { position: fixed; inset: 0; display: none; flex-direction: column; z-index: 10; }
        .screen.active { display: flex; }
        .nav-bar { position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); width: 92%; max-width: 500px; height: 75px; display: flex; justify-content: space-around; align-items: center; z-index: 100; }
        .announcement-bar { background: linear-gradient(90deg, transparent, var(--primary), transparent); white-space: nowrap; overflow: hidden; position: relative; }
        .marquee { display: inline-block; padding-right: 100%; animation: marquee 25s linear infinite; }
        @keyframes marquee { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        .popular-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
        ::-webkit-scrollbar { width: 3px; }
        ::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 10px; }
    </style>
</head>
<body class="dark-mode">

    <div class="bg-fixed-library"></div>
    <div class="bg-overlay"></div>

    <div id="system-announcement" class="fixed top-0 left-0 w-full h-8 z-[50] announcement-bar text-white text-[11px] font-bold hidden items-center">
        <div class="marquee" id="ann-text">مرحباً بكم في رَفوف</div>
    </div>

    <section id="scr-login" class="screen active items-center justify-center p-6">
        <div class="glass p-10 w-full max-w-sm text-center border-sky-500/30">
            <h1 class="text-6xl font-black mb-2 text-sky-500 italic">رَفوف</h1>
            <p class="opacity-60 mb-10 text-[10px] font-bold uppercase tracking-widest">إدارة المحتوى الذكية</p>
            <div class="space-y-4">
                <input id="in-name" type="text" placeholder="الاسم" class="w-full p-4 rounded-2xl glass font-bold text-center">
                <input id="in-phone" type="text" placeholder="رقم الهاتف / كود الأدمن" class="w-full p-4 rounded-2xl glass font-bold text-center">
                <button onclick="login()" class="w-full bg-sky-500 py-4 rounded-2xl font-black text-white shadow-xl">دخول</button>
            </div>
        </div>
    </section>

    <section id="scr-main" class="screen pt-10">
        <header class="p-6 flex justify-between items-center">
            <div>
                <h2 class="text-4xl font-black italic">المكتبة</h2>
                <div class="flex gap-2 mt-2">
                    <button onclick="setTheme('light')" class="w-5 h-5 rounded-full bg-amber-400 border border-white"></button>
                    <button onclick="setTheme('dark')" class="w-5 h-5 rounded-full bg-slate-900 border border-white"></button>
                </div>
            </div>
            <button onclick="openAdd()" class="w-12 h-12 glass flex items-center justify-center rounded-2xl text-sky-500">
                <i data-lucide="plus"></i>
            </button>
        </header>

        <div class="px-6 mb-4">
            <div class="glass flex items-center px-4 py-2 gap-3">
                <i data-lucide="search" class="w-4 h-4 opacity-40"></i>
                <input id="search-input" oninput="searchAll()" type="text" placeholder="ابحث عن كتاب، مستخدم، أو رقم هاتف..." class="bg-transparent border-none outline-none w-full text-xs font-bold">
            </div>
        </div>

        <div id="grid-scroll" class="overflow-y-auto px-6 pb-32 pt-2 flex-grow">
            <div id="poll-area" class="mb-8 hidden"></div>

            <h3 class="text-[10px] font-black opacity-30 mb-4 uppercase tracking-widest flex items-center gap-2">
                <i data-lucide="award" class="w-3 h-3 text-amber-500"></i> الأكثر شهرة
            </h3>
            <div id="popular-grid" class="popular-grid mb-10"></div>
            
            <h3 class="text-[10px] font-black opacity-30 mb-4 uppercase tracking-widest">المحتوى والمستخدمين</h3>
            <div id="books-grid" class="space-y-6"></div>
        </div>
    </section>

    <section id="scr-admin" class="screen p-6 pt-20 overflow-y-auto pb-32">
        <h2 class="text-4xl font-black text-red-500 italic mb-10 flex items-center gap-3">
            <i data-lucide="shield-check"></i> التحكم الكامل
        </h2>
        
        <div class="space-y-6">
            <div class="glass p-6 border-amber-500/20">
                <h3 class="text-xs font-black mb-4 opacity-50 flex items-center gap-2">
                    <i data-lucide="bar-chart-3" class="w-4 h-4"></i> نشر تصويت للجمهور
                </h3>
                <input id="adm-poll-q" type="text" placeholder="السؤال..." class="w-full p-4 rounded-xl glass mb-2 text-xs">
                <div class="grid grid-cols-2 gap-2 mb-3">
                    <input id="adm-poll-o1" type="text" placeholder="خيار 1" class="p-3 rounded-xl glass text-xs">
                    <input id="adm-poll-o2" type="text" placeholder="خيار 2" class="p-3 rounded-xl glass text-xs">
                </div>
                <button onclick="createPoll()" class="w-full bg-amber-500 text-white font-black py-3 rounded-xl text-xs">بدء التصويت</button>
            </div>

            <div class="glass p-6 border-red-500/20">
                <h3 class="text-xs font-black mb-4 opacity-50 flex items-center gap-2">
                    <i data-lucide="users" class="w-4 h-4"></i> قاعدة بيانات المستخدمين
                </h3>
                <div id="adm-users-list" class="space-y-3 max-h-60 overflow-y-auto pr-2"></div>
            </div>

            <div class="glass p-6">
                <h3 class="text-xs font-black mb-4 opacity-50 flex items-center gap-2">
                    <i data-lucide="book-open" class="w-4 h-4"></i> إدارة الكتب
                </h3>
                <div id="adm-books-list" class="space-y-3 max-h-60 overflow-y-auto pr-2"></div>
            </div>
        </div>
    </section>

    <nav class="nav-bar glass shadow-2xl" id="app-nav" style="display:none">
        <div onclick="nav('scr-main')" id="n-main" class="flex flex-col items-center gap-1 text-sky-500">
            <i data-lucide="home"></i>
            <span class="text-[8px] font-bold">المكتبة</span>
        </div>
        <div id="n-admin" onclick="nav('scr-admin')" class="hidden flex flex-col items-center gap-1 opacity-30 text-red-500">
            <i data-lucide="shield"></i>
            <span class="text-[8px] font-bold">الإدارة</span>
        </div>
        <div onclick="logout()" class="flex flex-col items-center gap-1 opacity-20">
            <i data-lucide="log-out"></i>
        </div>
    </nav>

    <div id="mod-global" class="fixed inset-0 bg-black/90 hidden z-[1000] items-center justify-center p-4 backdrop-blur-xl">
        <div class="glass p-8 w-full max-w-md relative animate-in fade-in zoom-in duration-300">
            <button onclick="closeMod()" class="absolute top-5 right-5 opacity-40"><i data-lucide="x"></i></button>
            <h3 class="text-2xl font-black mb-8 text-sky-500 italic">إضافة كتاب</h3>
            <div class="space-y-4">
                <input id="new-t" type="text" placeholder="عنوان الكتاب" class="w-full p-4 rounded-xl glass font-bold text-sm">
                <input id="new-c" type="text" placeholder="رابط صورة الغلاف" class="w-full p-4 rounded-xl glass text-sm">
                <textarea id="new-desc" placeholder="وصف الكتاب..." class="w-full p-4 rounded-xl glass text-xs h-28"></textarea>
                <button onclick="saveNew()" class="w-full bg-sky-500 py-4 rounded-2xl font-black text-white">نشر</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, get, remove, update, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = { databaseURL: "https://coffee-spark-ai-barista-370d0-default-rtdb.firebaseio.com" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        let user = JSON.parse(localStorage.getItem('rafouf_admin_user'));
        const ADMIN_CODE = "admin99";
        let allBooks = [], allUsers = [];

        window.setTheme = (mode) => {
            document.body.className = mode + '-mode';
            localStorage.setItem('rafouf_admin_theme', mode);
        };
        setTheme(localStorage.getItem('rafouf_admin_theme') || 'dark');

        window.nav = (id) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id !== 'scr-login'){
                document.getElementById('app-nav').style.display = 'flex';
                document.getElementById('n-admin').classList.toggle('hidden', !user.isAdmin);
            }
            lucide.createIcons();
        };

        window.login = async () => {
            const n = document.getElementById('in-name').value, p = document.getElementById('in-phone').value;
            if(!n || !p) return;
            user = { name: n, phone: p, isAdmin: p === ADMIN_CODE };
            localStorage.setItem('rafouf_admin_user', JSON.stringify(user));
            await update(ref(db, `users/${p}`), { name: n, phone: p, last: Date.now() });
            start();
        };

        function start() { nav('scr-main'); syncData(); }

        function syncData() {
            // مزامنة التصويت
            onValue(ref(db, 'system/poll'), (snap) => {
                const area = document.getElementById('poll-area');
                if(snap.exists()){
                    const p = snap.val();
                    const total = (p.v1 || 0) + (p.v2 || 0);
                    const pc1 = total ? Math.round((p.v1 || 0)/total*100) : 0;
                    const pc2 = total ? 100 - pc1 : 0;
                    area.innerHTML = `
                        <div class="glass p-5 border-amber-500/30">
                            <h4 class="text-xs font-black mb-4 flex items-center gap-2"><i data-lucide="help-circle" class="text-amber-500 w-4 h-4"></i> ${p.q}</h4>
                            <div class="space-y-3">
                                <button onclick="vote(1)" class="relative w-full p-3 rounded-xl bg-white/5 text-right overflow-hidden group">
                                    <div class="absolute inset-0 bg-amber-500/20 transition-all" style="width:${pc1}%"></div>
                                    <span class="relative z-10 text-[11px] font-bold flex justify-between"><span>${p.o1}</span> <span>${pc1}%</span></span>
                                </button>
                                <button onclick="vote(2)" class="relative w-full p-3 rounded-xl bg-white/5 text-right overflow-hidden">
                                    <div class="absolute inset-0 bg-sky-500/20 transition-all" style="width:${pc2}%"></div>
                                    <span class="relative z-10 text-[11px] font-bold flex justify-between"><span>${p.o2}</span> <span>${pc2}%</span></span>
                                </button>
                            </div>
                        </div>`;
                    area.classList.remove('hidden');
                } else area.classList.add('hidden');
                lucide.createIcons();
            });

            // مزامنة المستخدمين (للأدمن)
            if(user.isAdmin) {
                onValue(ref(db, 'users'), (snap) => {
                    const list = document.getElementById('adm-users-list');
                    list.innerHTML = '';
                    allUsers = [];
                    if(snap.exists()){
                        Object.entries(snap.val()).forEach(([id, u]) => {
                            allUsers.push(u);
                            list.innerHTML += `
                                <div class="bg-black/20 p-3 rounded-xl flex justify-between items-center text-[10px] border border-white/5">
                                    <div><p class="font-black">${u.name}</p><p class="opacity-50">${u.phone}</p></div>
                                    <button onclick="delUser('${id}')" class="text-red-500"><i data-lucide="user-minus" class="w-4 h-4"></i></button>
                                </div>`;
                        });
                    }
                    lucide.createIcons();
                });
            }

            // مزامنة الكتب والمتابعات
            onValue(ref(db, 'content'), (snap) => {
                allBooks = snap.exists() ? Object.entries(snap.val()) : [];
                renderList(allBooks);
            });
        }

        window.renderList = (items) => {
            const grid = document.getElementById('books-grid');
            const popGrid = document.getElementById('popular-grid');
            const admBookList = document.getElementById('adm-books-list');
            grid.innerHTML = ''; popGrid.innerHTML = ''; if(admBookList) admBookList.innerHTML = '';

            const popular = [...items].sort((a,b) => (b[1].likes || 0) - (a[1].likes || 0)).slice(0, 4);
            popular.forEach(([id, item]) => {
                popGrid.innerHTML += `<div class="glass p-3 flex flex-col items-center"><img src="${item.cover}" class="w-full aspect-[3/4] object-cover rounded-xl mb-2"><h4 class="text-[9px] font-black truncate w-full text-center">${item.title}</h4></div>`;
            });

            items.reverse().forEach(([id, item]) => {
                const isFollowing = user.following && user.following[item.ownerId];
                grid.innerHTML += `
                    <div class="glass p-5 relative border-white/5">
                        <div class="flex gap-4">
                            <img src="${item.cover}" class="w-20 h-28 object-cover rounded-xl shadow-xl">
                            <div class="flex-grow">
                                <h3 class="font-black text-lg">${item.title}</h3>
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="text-sky-500 text-[10px] font-bold">@${item.ownerName}</span>
                                    <button onclick="toggleFollow('${item.ownerId}', '${item.ownerName}')" class="text-[9px] px-2 py-0.5 rounded-full border border-sky-500/50 ${isFollowing ? 'bg-sky-500 text-white' : 'text-sky-500'}">
                                        ${isFollowing ? 'متابع' : 'متابعة'}
                                    </button>
                                </div>
                                <p class="text-[10px] opacity-50 line-clamp-2 italic">${item.description || ''}</p>
                            </div>
                        </div>
                    </div>`;
                if(user.isAdmin && admBookList) {
                    admBookList.innerHTML += `<div class="bg-black/20 p-2 rounded-lg flex justify-between text-xs items-center"><span>${item.title}</span><button onclick="delBook('${id}')" class="text-red-500"><i data-lucide="trash-2" class="w-3 h-3"></i></button></div>`;
                }
            });
            lucide.createIcons();
        };

        window.searchAll = () => {
            const q = document.getElementById('search-input').value.toLowerCase();
            const filtered = allBooks.filter(([id, b]) => 
                b.title.toLowerCase().includes(q) || 
                b.ownerName.toLowerCase().includes(q) || 
                b.ownerId.includes(q)
            );
            renderList(filtered);
        };

        window.createPoll = () => {
            const q = document.getElementById('adm-poll-q').value;
            const o1 = document.getElementById('adm-poll-o1').value, o2 = document.getElementById('adm-poll-o2').value;
            if(q && o1 && o2) set(ref(db, 'system/poll'), { q, o1, o2, v1: 0, v2: 0 });
        };

        window.vote = (idx) => {
            update(ref(db, 'system/poll'), { [`v${idx}`]: increment(1) });
        };

        window.toggleFollow = async (id, name) => {
            if(id === user.phone) return;
            const path = `users/${user.phone}/following/${id}`;
            const snap = await get(ref(db, path));
            if(snap.exists()) {
                remove(ref(db, path));
                delete user.following[id];
            } else {
                set(ref(db, path), name);
                if(!user.following) user.following = {};
                user.following[id] = name;
            }
            localStorage.setItem('rafouf_admin_user', JSON.stringify(user));
            renderList(allBooks);
        };

        window.delUser = (id) => { if(confirm("حذف المستخدم نهائياً؟")) remove(ref(db, `users/${id}`)); };
        window.delBook = (id) => { if(confirm("حذف الكتاب؟")) remove(ref(db, `content/${id}`)); };
        window.openAdd = () => document.getElementById('mod-global').classList.replace('hidden', 'flex');
        window.closeMod = () => document.getElementById('mod-global').classList.replace('flex','hidden');
        window.saveNew = () => {
            const t = document.getElementById('new-t').value, c = document.getElementById('new-c').value, d = document.getElementById('new-desc').value;
            if(t && c) {
                push(ref(db, 'content'), { title: t, cover: c, description: d, ownerId: user.phone, ownerName: user.name, likes: 0 });
                closeMod();
            }
        };
        window.logout = () => { localStorage.clear(); location.reload(); };
        if(user) start();
        lucide.createIcons();
    </script>
</body>
</html>