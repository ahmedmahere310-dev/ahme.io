<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>رَفوف | التواصل والإدارة</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root { --primary: #0ea5e9; }
        body { font-family: 'Cairo', sans-serif; height: 100vh; overflow: hidden; }
        .bg-fixed-library { position: fixed; inset: 0; background: url('https://images.unsplash.com/photo-1507842217343-583bb7270b66?auto=format&fit=crop&q=80') center/cover no-repeat; z-index: -2; }
        .bg-overlay { position: fixed; inset: 0; z-index: -1; background: rgba(2, 6, 23, 0.75); backdrop-filter: blur(8px); }
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 1.5rem; }
        .screen { position: fixed; inset: 0; display: none; flex-direction: column; z-index: 10; }
        .screen.active { display: flex; }
        .nav-bar { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 92%; max-width: 500px; height: 75px; display: flex; justify-content: space-around; align-items: center; z-index: 100; }
        .announcement-bar { background: linear-gradient(90deg, transparent, #ef4444, transparent); white-space: nowrap; overflow: hidden; height: 30px; display: flex; align-items: center; }
        .marquee { display: inline-block; animation: marquee 20s linear infinite; font-size: 11px; font-weight: bold; color: white; }
        @keyframes marquee { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        .chat-bubble { max-width: 80%; padding: 10px 15px; border-radius: 18px; font-size: 13px; margin-bottom: 8px; line-height: 1.5; }
        .chat-mine { background: var(--primary); align-self: flex-end; border-bottom-right-radius: 4px; }
        .chat-theirs { background: rgba(255,255,255,0.1); align-self: flex-start; border-bottom-left-radius: 4px; }
    </style>
</head>
<body class="text-white">

    <div class="bg-fixed-library"></div>
    <div class="bg-overlay"></div>

    <!-- شريط الإعلان -->
    <div id="ann-container" class="fixed top-0 left-0 w-full z-[100] announcement-bar hidden">
        <div class="marquee" id="ann-text"></div>
    </div>

    <!-- شاشة الدخول -->
    <section id="scr-login" class="screen active items-center justify-center p-6">
        <div class="glass p-10 w-full max-w-sm text-center">
            <h1 class="text-6xl font-black mb-2 text-sky-500 italic">رَفوف</h1>
            <p class="opacity-40 mb-10 text-[10px] tracking-widest uppercase">نظام التبادل والدردشة</p>
            <div class="space-y-4">
                <input id="in-name" type="text" placeholder="الاسم الكريم" class="w-full p-4 rounded-2xl glass text-center font-bold outline-none border-none">
                <input id="in-phone" type="text" placeholder="رقم الهاتف أو كود الإدارة" class="w-full p-4 rounded-2xl glass text-center font-bold outline-none border-none">
                <button onclick="login()" class="w-full bg-sky-600 py-4 rounded-2xl font-black shadow-xl active:scale-95 transition-all">دخول</button>
            </div>
        </div>
    </section>

    <!-- الرئيسية -->
    <section id="scr-main" class="screen pt-12">
        <header class="p-6 flex justify-between items-center">
            <h2 class="text-4xl font-black italic">المكتبة</h2>
            <div class="flex gap-2">
                <button onclick="nav('scr-profile')" class="w-10 h-10 glass flex items-center justify-center rounded-xl overflow-hidden">
                    <img id="my-pfp-small" src="https://api.dicebear.com/7.x/avataaars/svg?seed=Lucky" class="w-full h-full object-cover">
                </button>
                <button onclick="openAdd()" class="w-10 h-10 glass flex items-center justify-center rounded-xl text-sky-400">
                    <i data-lucide="plus"></i>
                </button>
            </div>
        </header>
        <div class="px-6 mb-4">
            <div class="glass flex items-center px-4 py-3 gap-3">
                <i data-lucide="search" class="w-5 h-5 opacity-40"></i>
                <input id="book-search" oninput="searchBooks()" type="text" placeholder="بحث في الكتب..." class="bg-transparent outline-none w-full text-sm">
            </div>
        </div>
        <div id="main-scroll" class="overflow-y-auto px-6 pb-32 flex-grow">
            <div id="poll-area" class="mb-6 hidden"></div>
            <div id="books-grid" class="space-y-4"></div>
        </div>
    </section>

    <!-- شاشة اكتشف (بحث مستخدمين) -->
    <section id="scr-discover" class="screen pt-12">
        <div class="p-6">
            <h2 class="text-4xl font-black mb-6">اكتشف</h2>
            <div class="glass flex items-center px-4 py-3 gap-3 mb-6">
                <i data-lucide="users" class="w-5 h-5 opacity-40"></i>
                <input id="user-search" oninput="searchUsers()" type="text" placeholder="بحث بالاسم أو الرقم..." class="bg-transparent outline-none w-full text-sm">
            </div>
            <div id="users-grid" class="space-y-3 overflow-y-auto pb-32"></div>
        </div>
    </section>

    <!-- شاشة الرسائل -->
    <section id="scr-chats" class="screen pt-12">
        <div class="p-6">
            <h2 class="text-4xl font-black mb-6 italic">الرسائل</h2>
            <div id="chats-list" class="space-y-2"></div>
        </div>
    </section>

    <!-- نافذة الشات -->
    <section id="scr-chat-window" class="screen bg-slate-950">
        <header class="p-4 glass rounded-none flex items-center gap-4">
            <button onclick="nav('scr-chats')"><i data-lucide="arrow-right"></i></button>
            <div class="w-10 h-10 rounded-full bg-white/10 overflow-hidden">
                <img id="chat-target-img" src="" class="w-full h-full object-cover">
            </div>
            <div>
                <h4 id="chat-target-name" class="font-bold text-sm">...</h4>
                <p id="chat-target-status" class="text-[9px]">جاري التحميل...</p>
            </div>
        </header>
        <div id="chat-messages" class="flex-grow overflow-y-auto p-4 flex flex-col"></div>
        <div class="p-4 glass rounded-none flex gap-2">
            <input id="chat-input" type="text" placeholder="اكتب رسالة..." class="flex-grow bg-white/5 p-4 rounded-2xl text-sm outline-none border-none">
            <button onclick="sendMessage()" class="w-14 h-14 bg-sky-600 rounded-2xl flex items-center justify-center active:scale-90 transition-all">
                <i data-lucide="send" class="w-6 h-6"></i>
            </button>
        </div>
    </section>

    <!-- شاشة الملف الشخصي -->
    <section id="scr-profile" class="screen pt-12">
        <div class="p-6 flex flex-col items-center">
            <div class="w-24 h-24 rounded-3xl glass p-1 mb-4 relative">
                <img id="profile-img-preview" src="" class="w-full h-full object-cover rounded-2xl">
            </div>
            <h3 id="profile-name-view" class="text-xl font-black mb-1">...</h3>
            <p id="profile-phone-view" class="text-[10px] opacity-40 mb-8 tracking-widest">...</p>
            
            <div class="glass p-6 w-full space-y-4">
                <div>
                    <label class="text-[10px] font-bold opacity-40 px-2">الاسم المعروض</label>
                    <input id="edit-name" type="text" class="w-full bg-white/5 p-3 rounded-xl mt-1 outline-none text-sm">
                </div>
                <div>
                    <label class="text-[10px] font-bold opacity-40 px-2">رابط الصورة الشخصية</label>
                    <input id="edit-pfp" type="text" class="w-full bg-white/5 p-3 rounded-xl mt-1 outline-none text-sm">
                </div>
                <div>
                    <label class="text-[10px] font-bold opacity-40 px-2">النبذة الشخصية</label>
                    <textarea id="edit-bio" class="w-full bg-white/5 p-3 rounded-xl mt-1 outline-none text-sm h-20"></textarea>
                </div>
                <button onclick="saveProfile()" class="w-full bg-emerald-600 py-3 rounded-xl font-bold text-sm">حفظ التغييرات</button>
            </div>
        </div>
    </section>

    <!-- لوحة الإدارة -->
    <section id="scr-admin" class="screen p-6 pt-16 overflow-y-auto pb-32">
        <h2 class="text-3xl font-black text-red-500 mb-8 flex items-center gap-2">
            <i data-lucide="shield-check"></i> التحكم الكامل
        </h2>
        <div class="space-y-6">
            <div class="glass p-5 border-amber-500/20">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xs font-bold">إدارة التصويت</h3>
                    <button onclick="deletePoll()" class="text-red-500 bg-red-500/10 px-3 py-1 rounded-lg text-[10px]">حذف الفوت</button>
                </div>
                <input id="adm-poll-q" type="text" placeholder="السؤال" class="w-full p-3 glass mb-2 text-xs">
                <div class="grid grid-cols-2 gap-2"><input id="adm-poll-o1" placeholder="خيار 1" class="glass p-2 text-xs"><input id="adm-poll-o2" placeholder="خيار 2" class="glass p-2 text-xs"></div>
                <button onclick="createPoll()" class="w-full bg-amber-600 mt-3 py-3 rounded-xl text-xs font-bold">نشر التصويت</button>
            </div>
            <div class="glass p-5 border-sky-500/20">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xs font-bold">شريط الإعلان</h3>
                    <button onclick="toggleAnn(false)" class="text-gray-400 bg-white/5 px-3 py-1 rounded-lg text-[10px]">إخفاء</button>
                </div>
                <input id="adm-ann-msg" type="text" placeholder="نص الإعلان..." class="w-full p-3 glass mb-3 text-xs">
                <button onclick="toggleAnn(true)" class="w-full bg-sky-600 py-3 rounded-xl text-xs font-bold">تحديث</button>
            </div>
            <div class="glass p-5">
                <h3 class="text-xs font-bold mb-4">المستخدمين والكتب</h3>
                <div id="adm-users-list" class="space-y-2 mb-4"></div>
                <div id="adm-books-list" class="space-y-2"></div>
            </div>
        </div>
    </section>

    <!-- الملاحة -->
    <nav id="nav-bar" class="nav-bar glass hidden shadow-2xl">
        <div onclick="nav('scr-main')" id="n-main" class="flex flex-col items-center gap-1 text-sky-500 transition-all">
            <i data-lucide="home"></i><span class="text-[8px] font-bold">المكتبة</span>
        </div>
        <div onclick="nav('scr-discover')" id="n-discover" class="flex flex-col items-center gap-1 opacity-30 transition-all">
            <i data-lucide="users"></i><span class="text-[8px] font-bold">اكتشف</span>
        </div>
        <div onclick="nav('scr-chats')" id="n-chats" class="flex flex-col items-center gap-1 opacity-30 transition-all">
            <i data-lucide="message-square"></i><span class="text-[8px] font-bold">الرسايل</span>
        </div>
        <div id="nav-adm" onclick="nav('scr-admin')" class="hidden flex flex-col items-center gap-1 text-red-500 opacity-30">
            <i data-lucide="shield"></i><span class="text-[8px] font-bold">الإدارة</span>
        </div>
    </nav>

    <!-- إضافة كتاب -->
    <div id="mod-add" class="fixed inset-0 bg-black/90 hidden z-[200] items-center justify-center p-6 backdrop-blur-md">
        <div class="glass p-8 w-full max-w-md relative">
            <button onclick="document.getElementById('mod-add').classList.replace('flex','hidden')" class="absolute top-4 right-4 opacity-50"><i data-lucide="x"></i></button>
            <h3 class="text-2xl font-black mb-6 text-sky-400">إضافة كتاب</h3>
            <div class="space-y-3">
                <input id="add-t" type="text" placeholder="عنوان الكتاب" class="w-full p-4 glass rounded-xl text-sm">
                <input id="add-c" type="text" placeholder="رابط صورة الغلاف" class="w-full p-4 glass rounded-xl text-sm">
                <textarea id="add-d" placeholder="وصف الكتاب..." class="w-full p-4 glass rounded-xl text-xs h-24"></textarea>
                <button onclick="saveBook()" class="w-full bg-sky-600 py-4 rounded-2xl font-black">نشر الآن</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, remove, update, increment, get, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = { databaseURL: "https://coffee-spark-ai-barista-370d0-default-rtdb.firebaseio.com" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let user = JSON.parse(localStorage.getItem('rafouf_session'));
        let cacheBooks = [], cacheUsers = [], chatTarget = null;

        window.nav = (id) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('nav div').forEach(d => d.classList.add('opacity-30'));
            const activeNav = { 'scr-main': 'n-main', 'scr-discover': 'n-discover', 'scr-chats': 'n-chats', 'scr-admin': 'nav-adm' }[id];
            if(activeNav) document.getElementById(activeNav).classList.remove('opacity-30');
            lucide.createIcons();
        };

        window.login = async () => {
            const n = document.getElementById('in-name').value, p = document.getElementById('in-phone').value;
            if(!n || !p) return;
            const pfp = `https://api.dicebear.com/7.x/avataaars/svg?seed=${n}`;
            user = { name: n, phone: p, pfp, isAdmin: p === 'admin99', bio: 'أهلاً بك في ملفي الشخصي' };
            localStorage.setItem('rafouf_session', JSON.stringify(user));
            await update(ref(db, `users/${p}`), { ...user, lastSeen: serverTimestamp() });
            start();
        };

        function start() {
            document.getElementById('nav-bar').classList.remove('hidden');
            if(user.isAdmin) document.getElementById('nav-adm').classList.remove('hidden');
            nav('scr-main');
            updatePresence();
            syncData();
            loadProfileFields();
        }

        function updatePresence() {
            update(ref(db, `users/${user.phone}`), { lastSeen: serverTimestamp() });
            setInterval(() => update(ref(db, `users/${user.phone}`), { lastSeen: serverTimestamp() }), 60000);
        }

        function syncData() {
            // مزامنة المستخدمين
            onValue(ref(db, 'users'), (snap) => {
                cacheUsers = snap.exists() ? Object.entries(snap.val()) : [];
                renderUsers(cacheUsers);
                if(user.isAdmin) renderAdminPanel();
                if(chatTarget) updateChatTargetStatus(chatTarget.phone);
            });

            // مزامنة الإعلان
            onValue(ref(db, 'system/announcement'), (snap) => {
                const a = snap.val();
                const container = document.getElementById('ann-container');
                if(a && a.v) { container.classList.remove('hidden'); document.getElementById('ann-text').innerText = a.msg; }
                else container.classList.add('hidden');
            });

            // مزامنة التصويت
            onValue(ref(db, 'system/poll'), (snap) => {
                const p = snap.val();
                const area = document.getElementById('poll-area');
                if(p) {
                    const total = (p.v1||0)+(p.v2||0);
                    const calc = (v) => total ? Math.round(v/total*100) : 0;
                    area.innerHTML = `<div class="glass p-5 border-amber-500/20"><h4 class="text-xs font-black mb-4">${p.q}</h4>
                        <button onclick="vote(1)" class="w-full h-11 glass rounded-xl mb-2 px-4 flex justify-between items-center text-[10px] font-bold"><span>${p.o1}</span><span>${calc(p.v1)}%</span></button>
                        <button onclick="vote(2)" class="w-full h-11 glass rounded-xl px-4 flex justify-between items-center text-[10px] font-bold"><span>${p.o2}</span><span>${calc(p.v2)}%</span></button></div>`;
                    area.classList.remove('hidden');
                } else area.classList.add('hidden');
            });

            // مزامنة الكتب
            onValue(ref(db, 'content'), (snap) => {
                cacheBooks = snap.exists() ? Object.entries(snap.val()) : [];
                renderBooks(cacheBooks);
            });

            // مزامنة قائمة المحادثات
            onValue(ref(db, `user_chats/${user.phone}`), (snap) => {
                const list = document.getElementById('chats-list');
                list.innerHTML = '';
                if(snap.exists()){
                    Object.entries(snap.val()).forEach(([id, c]) => {
                        list.innerHTML += `<div onclick="openChat('${id}')" class="glass p-4 flex items-center gap-4 cursor-pointer active:scale-95 transition-all">
                            <img src="${c.pfp}" class="w-12 h-12 rounded-full object-cover">
                            <div class="flex-grow"><h4 class="font-bold text-sm">${c.name}</h4><p class="text-[9px] opacity-40">اضغط لمراسلة ${c.name}</p></div>
                            <i data-lucide="chevron-left" class="w-4 h-4 opacity-30"></i>
                        </div>`;
                    });
                }
                lucide.createIcons();
            });
        }

        window.renderBooks = (data) => {
            const grid = document.getElementById('books-grid');
            grid.innerHTML = '';
            data.reverse().forEach(([id, b]) => {
                grid.innerHTML += `<div class="glass p-4 flex gap-4"><img src="${b.cover}" class="w-20 h-28 object-cover rounded-xl shadow-2xl">
                    <div class="flex-grow"><h3 class="font-black text-sm mb-1">${b.title}</h3><p class="text-[10px] text-sky-400 mb-2">@${b.ownerName}</p>
                    <p class="text-[9px] opacity-40 line-clamp-2">${b.description || ''}</p></div></div>`;
            });
        };

        window.renderUsers = (data) => {
            const grid = document.getElementById('users-grid');
            grid.innerHTML = '';
            data.forEach(([id, u]) => {
                if(id === user.phone) return;
                grid.innerHTML += `<div class="glass p-4 flex items-center gap-4">
                    <img src="${u.pfp}" class="w-12 h-12 rounded-full object-cover">
                    <div class="flex-grow"><h4 class="font-bold text-sm">${u.name}</h4><p class="text-[9px] opacity-40">${u.phone}</p></div>
                    <button onclick="openChat('${id}')" class="bg-sky-600 px-4 py-2 rounded-xl text-[10px] font-bold">مراسلة</button>
                </div>`;
            });
            lucide.createIcons();
        };

        window.searchBooks = () => {
            const q = document.getElementById('book-search').value.toLowerCase();
            renderBooks(cacheBooks.filter(([id, b]) => b.title.toLowerCase().includes(q) || b.ownerName.toLowerCase().includes(q)));
        };

        window.searchUsers = () => {
            const q = document.getElementById('user-search').value.toLowerCase();
            renderUsers(cacheUsers.filter(([id, u]) => u.name.toLowerCase().includes(q) || u.phone.includes(q)));
        };

        window.openChat = async (targetId) => {
            const targetData = (await get(ref(db, `users/${targetId}`))).val();
            chatTarget = targetData;
            document.getElementById('chat-target-name').innerText = targetData.name;
            document.getElementById('chat-target-img').src = targetData.pfp;
            updateChatTargetStatus(targetId);
            
            const chatId = [user.phone, targetId].sort().join('_');
            nav('scr-chat-window');
            
            // تحديث الفهرس
            update(ref(db, `user_chats/${user.phone}/${targetId}`), { name: targetData.name, pfp: targetData.pfp });
            update(ref(db, `user_chats/${targetId}/${user.phone}`), { name: user.name, pfp: user.pfp });

            onValue(ref(db, `chats/${chatId}`), (snap) => {
                const box = document.getElementById('chat-messages');
                box.innerHTML = '';
                if(snap.exists()){
                    Object.values(snap.val()).forEach(m => {
                        const side = m.sender === user.phone ? 'chat-mine' : 'chat-theirs';
                        box.innerHTML += `<div class="chat-bubble ${side}">${m.text}</div>`;
                    });
                    box.scrollTop = box.scrollHeight;
                }
            });
        };

        function updateChatTargetStatus(targetId) {
            const u = cacheUsers.find(x => x[0] === targetId);
            if(!u) return;
            const last = u[1].lastSeen;
            const diff = Date.now() - last;
            const status = document.getElementById('chat-target-status');
            if(diff < 120000) { status.innerText = 'متصل الآن'; status.className = 'text-[9px] text-emerald-400'; }
            else { 
                const mins = Math.floor(diff/60000);
                status.innerText = `نشط منذ ${mins > 60 ? Math.floor(mins/60) + ' ساعة' : mins + ' دقيقة'}`;
                status.className = 'text-[9px] opacity-40';
            }
        }

        window.sendMessage = () => {
            const inp = document.getElementById('chat-input');
            if(!inp.value || !chatTarget) return;
            const chatId = [user.phone, chatTarget.phone].sort().join('_');
            push(ref(db, `chats/${chatId}`), { sender: user.phone, text: inp.value, time: serverTimestamp() });
            inp.value = '';
        };

        // إدارة الملف الشخصي
        function loadProfileFields() {
            document.getElementById('profile-name-view').innerText = user.name;
            document.getElementById('profile-phone-view').innerText = user.phone;
            document.getElementById('profile-img-preview').src = user.pfp;
            document.getElementById('my-pfp-small').src = user.pfp;
            document.getElementById('edit-name').value = user.name;
            document.getElementById('edit-pfp').value = user.pfp;
            document.getElementById('edit-bio').value = user.bio || '';
        }

        window.saveProfile = async () => {
            const n = document.getElementById('edit-name').value, p = document.getElementById('edit-pfp').value, b = document.getElementById('edit-bio').value;
            user = { ...user, name: n, pfp: p, bio: b };
            localStorage.setItem('rafouf_session', JSON.stringify(user));
            await update(ref(db, `users/${user.phone}`), user);
            loadProfileFields();
            alert('تم حفظ البيانات بنجاح');
        };

        // وظائف الأدمن
        window.createPoll = () => {
            const q = document.getElementById('adm-poll-q').value;
            const o1 = document.getElementById('adm-poll-o1').value, o2 = document.getElementById('adm-poll-o2').value;
            if(q) set(ref(db, 'system/poll'), { q, o1, o2, v1:0, v2:0 });
        };
        window.deletePoll = () => remove(ref(db, 'system/poll'));
        window.toggleAnn = (v) => set(ref(db, 'system/announcement'), { msg: document.getElementById('adm-ann-msg').value, v });
        
        function renderAdminPanel() {
            const uList = document.getElementById('adm-users-list');
            const bList = document.getElementById('adm-books-list');
            uList.innerHTML = '<h4 class="text-[10px] opacity-40 mb-2">المستخدمين</h4>';
            bList.innerHTML = '<h4 class="text-[10px] opacity-40 mb-2">الكتب</h4>';
            
            cacheUsers.forEach(([id, u]) => {
                uList.innerHTML += `<div class="flex justify-between items-center text-xs glass p-2 rounded-xl"><span>${u.name}</span><button onclick="delUser('${id}')" class="text-red-500">حذف</button></div>`;
            });
            cacheBooks.forEach(([id, b]) => {
                bList.innerHTML += `<div class="flex justify-between items-center text-xs glass p-2 rounded-xl"><span>${b.title}</span><button onclick="delBook('${id}')" class="text-red-500">حذف</button></div>`;
            });
        }

        window.delUser = (id) => { if(confirm("حذف المستخدم؟")) remove(ref(db, `users/${id}`)); };
        window.delBook = (id) => { if(confirm("حذف الكتاب؟")) remove(ref(db, `content/${id}`)); };
        window.vote = (i) => update(ref(db, 'system/poll'), { [`v${i}`]: increment(1) });
        window.openAdd = () => document.getElementById('mod-add').classList.replace('hidden', 'flex');
        window.saveBook = () => {
            const t = document.getElementById('add-t').value, c = document.getElementById('add-c').value, d = document.getElementById('add-d').value;
            if(t && c) { push(ref(db, 'content'), { title: t, cover: c, description: d, ownerId: user.phone, ownerName: user.name }); document.getElementById('mod-add').classList.replace('flex','hidden'); }
        };

        if(user) start();
        lucide.createIcons();
    </script>
</body>
</html>